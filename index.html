<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EntryPlan Academy — Live Performance</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap');
:root{--bg:#080a0d;--bg2:#0e1117;--bg3:#141920;--border:#1c2330;--accent:#c8a85a;--accent2:#e6c97a;--green:#2dd4a0;--red:#f25c6e;--blue:#60a5fa;--text:#dde3ed;--muted:#556070;--card:#0f1318;}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
body::after{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.035'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:0.4;}
header{border-bottom:1px solid var(--border);padding:0 48px;display:flex;align-items:center;justify-content:space-between;height:68px;position:sticky;top:0;background:rgba(8,10,13,0.92);backdrop-filter:blur(20px);z-index:100;}
.logo-text{font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:2px;}
.logo-text span{color:var(--accent);}
.logo-sub{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);letter-spacing:2px;}
.live-badge{display:flex;align-items:center;gap:7px;font-family:'DM Mono',monospace;font-size:11px;letter-spacing:1.5px;color:var(--green);text-transform:uppercase;}
.live-dot{width:7px;height:7px;background:var(--green);border-radius:50%;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:0.4;transform:scale(1.3);}}
.hero{padding:48px 48px 36px;border-bottom:1px solid var(--border);position:relative;overflow:hidden;}
.hero::before{content:'EPA';position:absolute;right:-20px;top:-20px;font-family:'Bebas Neue',sans-serif;font-size:240px;color:rgba(200,168,90,0.025);pointer-events:none;line-height:1;}
.hero-label{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:3px;color:var(--accent);text-transform:uppercase;margin-bottom:12px;}
.hero-total{font-family:'Bebas Neue',sans-serif;font-size:clamp(44px,7vw,80px);letter-spacing:2px;line-height:1;margin-bottom:32px;}
.hero-row{display:flex;gap:40px;flex-wrap:wrap;}
.hero-stat-label{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:5px;}
.hero-stat-value{font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:1px;}
.hero-stat-value.green{color:var(--green);}
.hero-stat-value.red{color:var(--red);}
.hero-stat-value.gold{color:var(--accent2);}
.hero-stat-value.muted{color:var(--muted);font-size:18px;}
.main{max-width:1300px;margin:0 auto;padding:40px 48px;}
.section-label{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:3px;color:var(--muted);text-transform:uppercase;margin-bottom:20px;display:flex;align-items:center;gap:12px;}
.section-label::after{content:'';flex:1;height:1px;background:var(--border);}
.ea-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:48px;}
@media(max-width:900px){.ea-grid{grid-template-columns:1fr;}header{padding:0 20px;}.hero{padding:36px 20px 28px;}.main{padding:28px 20px;}}
.ea-card{background:var(--card);border:1px solid var(--border);border-radius:2px;overflow:hidden;transition:all 0.25s;cursor:pointer;}
.ea-card:hover{border-color:rgba(200,168,90,0.35);transform:translateY(-3px);box-shadow:0 12px 40px rgba(0,0,0,0.4);}
.ea-card-top-bar{height:3px;width:100%;}
.bar-gold{background:linear-gradient(90deg,var(--accent),var(--accent2));}
.bar-green{background:linear-gradient(90deg,var(--green),#16a37a);}
.bar-blue{background:linear-gradient(90deg,var(--blue),#3b82f6);}
.ea-card-header{padding:20px 22px 16px;border-bottom:1px solid var(--border);}
.ea-name{font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:1px;margin-bottom:4px;}
.ea-port{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);letter-spacing:1px;}
.ea-status{display:inline-flex;align-items:center;gap:5px;font-family:'DM Mono',monospace;font-size:10px;padding:3px 8px;border-radius:2px;margin-top:8px;}
.status-live{background:rgba(45,212,160,0.1);color:var(--green);border:1px solid rgba(45,212,160,0.25);}
.ea-card-body{padding:18px 22px;}
.ea-main-label{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:5px;}
.ea-main-value{font-family:'Bebas Neue',sans-serif;font-size:32px;letter-spacing:0.5px;margin-bottom:16px;}
.ea-main-value.green{color:var(--green);}
.ea-main-value.red{color:var(--red);}
.sparkline-wrap{height:50px;margin-bottom:16px;}
.ea-stats-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:8px;}
.ea-stat-label{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;}
.ea-stat-value{font-size:14px;font-weight:600;font-family:'DM Mono',monospace;}
.ea-stat-value.green{color:var(--green);}
.ea-stat-value.red{color:var(--red);}
.ea-stat-value.gold{color:var(--accent2);}
.ea-card-footer{padding:14px 22px;border-top:1px solid var(--border);}
.btn-detail{width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:10px;font-family:'DM Mono',monospace;font-size:11px;letter-spacing:1px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;border-radius:2px;}
.btn-detail:hover{border-color:var(--accent);color:var(--accent);}
#detail-page{display:none;position:fixed;inset:0;background:var(--bg);z-index:200;overflow-y:auto;}
.detail-header{border-bottom:1px solid var(--border);padding:0 48px;height:64px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:rgba(8,10,13,0.95);backdrop-filter:blur(20px);}
.btn-back{display:flex;align-items:center;gap:8px;background:none;border:1px solid var(--border);color:var(--muted);padding:8px 16px;font-family:'DM Mono',monospace;font-size:11px;letter-spacing:1px;cursor:pointer;transition:all 0.2s;border-radius:2px;}
.btn-back:hover{border-color:var(--text);color:var(--text);}
.detail-content{max-width:1100px;margin:0 auto;padding:40px 48px;}
@media(max-width:768px){.detail-header{padding:0 20px;}.detail-content{padding:24px 20px;}}
.d-hero{padding:0 0 32px;border-bottom:1px solid var(--border);margin-bottom:32px;}
.d-hero-name{font-family:'Bebas Neue',sans-serif;font-size:48px;letter-spacing:2px;margin-bottom:4px;}
.d-hero-sub{font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);letter-spacing:1.5px;margin-bottom:24px;}
.d-balance{font-family:'Bebas Neue',sans-serif;font-size:64px;letter-spacing:1px;color:var(--accent2);line-height:1;}
.d-equity-row{font-family:'DM Mono',monospace;font-size:12px;color:var(--muted);margin-top:6px;}
.d-equity-row span{color:var(--text);}
.d-stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--border);margin-bottom:24px;}
@media(max-width:700px){.d-stats-grid{grid-template-columns:repeat(2,1fr);}}
.d-stat{background:var(--card);padding:18px 20px;}
.d-stat-label{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:7px;}
.d-stat-value{font-size:20px;font-weight:600;}
.d-stat-value.green{color:var(--green);}
.d-stat-value.red{color:var(--red);}
.d-stat-value.gold{color:var(--accent2);}
.chart-card{background:var(--card);border:1px solid var(--border);border-radius:2px;margin-bottom:24px;}
.chart-card-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.chart-card-title{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);}
.chart-range-btns{display:flex;gap:14px;font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);}
.chart-range-btns span{cursor:pointer;transition:color 0.2s;}
.chart-body{padding:20px;}
.chart-wrap{height:260px;position:relative;}
.pnl-row{display:flex;align-items:center;justify-content:space-between;padding:13px 0;border-bottom:1px solid var(--border);}
.pnl-row:last-child{border:none;}
.pnl-period{font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;}
.pnl-val{font-family:'DM Mono',monospace;font-size:14px;font-weight:500;}
.pnl-val.green{color:var(--green);}
.pnl-val.red{color:var(--red);}
#loading{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:500;transition:opacity 0.5s;}
.load-logo{font-family:'Bebas Neue',sans-serif;font-size:44px;letter-spacing:4px;}
.load-logo span{color:var(--accent);}
.load-bar{width:180px;height:2px;background:var(--border);border-radius:1px;overflow:hidden;margin-top:20px;}
.load-fill{height:100%;background:var(--accent);animation:loadbar 1.5s ease forwards;}
@keyframes loadbar{from{width:0}to{width:100%}}
.load-text{font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);letter-spacing:2px;margin-top:10px;text-transform:uppercase;}
</style>
</head>
<body>

<div id="loading">
  <div class="load-logo">Entry<span>Plan</span></div>
  <div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);letter-spacing:3px;margin-top:2px;">ACADEMY</div>
  <div class="load-bar"><div class="load-fill"></div></div>
  <div class="load-text">Fetching live data...</div>
</div>

<div id="home-page">
  <header>
    <div>
      <div class="logo-text">Entry<span>Plan</span></div>
      <div class="logo-sub">Academy</div>
    </div>
    <div class="live-badge"><div class="live-dot"></div>Live Performance</div>
  </header>

  <section class="hero">
    <div class="hero-label">Combined Portfolio Summary</div>
    <div class="hero-total" id="hero-total">$0.00</div>
    <div class="hero-row">
      <div class="hero-stat">
        <div class="hero-stat-label">กำไรรวมทั้งหมด</div>
        <div class="hero-stat-value green" id="h-total-pnl">+$0.00</div>
      </div>
      <div class="hero-stat">
        <div class="hero-stat-label">กำไรเดือนนี้รวม</div>
        <div class="hero-stat-value green" id="h-monthly-pnl">+$0.00</div>
      </div>
      <div class="hero-stat">
        <div class="hero-stat-label">Active EAs</div>
        <div class="hero-stat-value gold">3</div>
      </div>
      <div class="hero-stat">
        <div class="hero-stat-label">Last Update</div>
        <div class="hero-stat-value muted" id="h-update">—</div>
      </div>
    </div>
  </section>

  <div class="main">
    <div class="section-label">Portfolio Overview</div>
    <div class="ea-grid">

      <div class="ea-card" onclick="openDetail('gradea')">
        <div class="ea-card-top-bar bar-gold"></div>
        <div class="ea-card-header">
          <div class="ea-name">Grade A</div>
          <div class="ea-port">PORT #501412</div>
          <div class="ea-status status-live"><span>●</span> LIVE</div>
        </div>
        <div class="ea-card-body">
          <div class="ea-main-label">กำไรตั้งแต่เริ่มรัน</div>
          <div class="ea-main-value green" id="ga-total-pnl">—</div>
          <div class="sparkline-wrap"><canvas id="spark-gradea"></canvas></div>
          <div class="ea-stats-row">
            <div><div class="ea-stat-label">กำไรเดือนนี้</div><div class="ea-stat-value green" id="ga-month-pnl">—</div></div>
            <div><div class="ea-stat-label">Win Rate</div><div class="ea-stat-value gold" id="ga-winrate">—</div></div>
            <div><div class="ea-stat-label">Balance</div><div class="ea-stat-value" id="ga-balance">—</div></div>
            <div><div class="ea-stat-label">Growth</div><div class="ea-stat-value gold" id="ga-growth">—</div></div>
          </div>
        </div>
        <div class="ea-card-footer"><button class="btn-detail">ดูรายละเอียด →</button></div>
      </div>

      <div class="ea-card" onclick="openDetail('blackhole')">
        <div class="ea-card-top-bar bar-green"></div>
        <div class="ea-card-header">
          <div class="ea-name">BlackHole</div>
          <div class="ea-port">PORT #501425</div>
          <div class="ea-status status-live"><span>●</span> LIVE</div>
        </div>
        <div class="ea-card-body">
          <div class="ea-main-label">กำไรตั้งแต่เริ่มรัน</div>
          <div class="ea-main-value green" id="bh-total-pnl">—</div>
          <div class="sparkline-wrap"><canvas id="spark-blackhole"></canvas></div>
          <div class="ea-stats-row">
            <div><div class="ea-stat-label">กำไรเดือนนี้</div><div class="ea-stat-value green" id="bh-month-pnl">—</div></div>
            <div><div class="ea-stat-label">Win Rate</div><div class="ea-stat-value gold" id="bh-winrate">—</div></div>
            <div><div class="ea-stat-label">Balance</div><div class="ea-stat-value" id="bh-balance">—</div></div>
            <div><div class="ea-stat-label">Growth</div><div class="ea-stat-value gold" id="bh-growth">—</div></div>
          </div>
        </div>
        <div class="ea-card-footer"><button class="btn-detail">ดูรายละเอียด →</button></div>
      </div>

      <div class="ea-card" onclick="openDetail('bigbang')">
        <div class="ea-card-top-bar bar-blue"></div>
        <div class="ea-card-header">
          <div class="ea-name">BigBang</div>
          <div class="ea-port">PORT #501427</div>
          <div class="ea-status status-live"><span>●</span> LIVE</div>
        </div>
        <div class="ea-card-body">
          <div class="ea-main-label">กำไรตั้งแต่เริ่มรัน</div>
          <div class="ea-main-value green" id="bb-total-pnl">—</div>
          <div class="sparkline-wrap"><canvas id="spark-bigbang"></canvas></div>
          <div class="ea-stats-row">
            <div><div class="ea-stat-label">กำไรเดือนนี้</div><div class="ea-stat-value green" id="bb-month-pnl">—</div></div>
            <div><div class="ea-stat-label">Win Rate</div><div class="ea-stat-value gold" id="bb-winrate">—</div></div>
            <div><div class="ea-stat-label">Balance</div><div class="ea-stat-value" id="bb-balance">—</div></div>
            <div><div class="ea-stat-label">Growth</div><div class="ea-stat-value gold" id="bb-growth">—</div></div>
          </div>
        </div>
        <div class="ea-card-footer"><button class="btn-detail">ดูรายละเอียด →</button></div>
      </div>

    </div>
    <div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);text-align:center;padding:20px 0 0;letter-spacing:0.5px;line-height:2;">
      Past performance is not indicative of future results. Trading involves substantial risk.<br>© 2025 EntryPlan Academy
    </div>
  </div>
</div>

<!-- DETAIL PAGE -->
<div id="detail-page">
  <div class="detail-header">
    <button class="btn-back" onclick="closeDetail()">← กลับหน้าหลัก</button>
    <div style="font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);letter-spacing:1.5px;" id="d-port-label">—</div>
  </div>
  <div class="detail-content">
    <div class="d-hero">
      <div class="d-hero-name" id="d-name">—</div>
      <div class="d-hero-sub" id="d-sub">—</div>
      <div class="d-balance" id="d-balance">$0.00</div>
      <div class="d-equity-row">Equity: <span id="d-equity">—</span> &nbsp;·&nbsp; Floating: <span id="d-floating">—</span></div>
    </div>

    <div class="d-stats-grid">
      <div class="d-stat"><div class="d-stat-label">กำไรตั้งแต่เริ่มรัน</div><div class="d-stat-value green" id="d-total-pnl">—</div></div>
      <div class="d-stat"><div class="d-stat-label">กำไรเดือนนี้</div><div class="d-stat-value green" id="d-month-pnl">—</div></div>
      <div class="d-stat"><div class="d-stat-label">กำไรวันนี้</div><div class="d-stat-value" id="d-daily-pnl">—</div></div>
      <div class="d-stat"><div class="d-stat-label">Growth</div><div class="d-stat-value gold" id="d-growth">—</div></div>
      <div class="d-stat"><div class="d-stat-label">Win Rate</div><div class="d-stat-value" id="d-winrate">—</div></div>
      <div class="d-stat"><div class="d-stat-label">Profit Factor</div><div class="d-stat-value" id="d-pf">—</div></div>
      <div class="d-stat"><div class="d-stat-label">Max Drawdown</div><div class="d-stat-value red" id="d-dd">—</div></div>
      <div class="d-stat"><div class="d-stat-label">Open Orders</div><div class="d-stat-value gold" id="d-open">—</div></div>
    </div>

    <div class="chart-card">
      <div class="chart-card-header">
        <div class="chart-card-title">Equity Curve</div>
        <div class="chart-range-btns">
          <span onclick="setRange('all')" id="r-all" style="color:var(--accent)">ALL</span>
          <span onclick="setRange('3m')" id="r-3m">3M</span>
          <span onclick="setRange('1m')" id="r-1m">1M</span>
          <span onclick="setRange('1w')" id="r-1w">1W</span>
        </div>
      </div>
      <div class="chart-body"><div class="chart-wrap"><canvas id="detailChart"></canvas></div></div>
    </div>

    <div class="chart-card">
      <div class="chart-card-header"><div class="chart-card-title">P&amp;L Summary</div></div>
      <div class="chart-body">
        <div class="pnl-row"><div class="pnl-period">กำไรวันนี้</div><div class="pnl-val" id="dp-daily">—</div></div>
        <div class="pnl-row"><div class="pnl-period">กำไรเดือนนี้</div><div class="pnl-val" id="dp-month">—</div></div>
        <div class="pnl-row"><div class="pnl-period">กำไรทั้งหมด</div><div class="pnl-val" id="dp-total">—</div></div>
        <div class="pnl-row"><div class="pnl-period">Total Trades</div><div class="pnl-val" id="dp-trades">—</div></div>
        <div class="pnl-row"><div class="pnl-period">Win / Lose</div><div class="pnl-val" id="dp-winlose">—</div></div>
      </div>
    </div>
  </div>
</div>

<script>
const SUPA_URL='https://stdvqepkkkeehojstfww.supabase.co';
const SUPA_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN0ZHZxZXBra2tlZWhvanN0Znd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyNTE5MjMsImV4cCI6MjA4NzgyNzkyM30.g25XS-O44n-Nf01-pRKy3pBH4OpYwQ7nbia67vHtx04';

const EA_CONFIG={
  gradea:   {name:'Grade A',  port:'501412',prefix:'ga',color:'#c8a85a'},
  blackhole:{name:'BlackHole',port:'501425',prefix:'bh',color:'#2dd4a0'},
  bigbang:  {name:'BigBang',  port:'501427',prefix:'bb',color:'#60a5fa'},
};

let allData={},allEquity={},detailChart=null,currentEA=null,currentRange='all',sparkCharts={};

async function fetchSupa(table,query=''){
  try{
    const r=await fetch(`${SUPA_URL}/rest/v1/${table}?${query}`,{headers:{'apikey':SUPA_KEY,'Authorization':`Bearer ${SUPA_KEY}`}});
    return r.ok?r.json():[];
  }catch(e){return[];}
}

function fUSD(v){if(v===null||v===undefined)return'—';const s=v>=0?'+':'-';return`${s}$${Math.abs(v).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}`;}
function fBal(v){return'$'+parseFloat(v||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});}
function fPct(v){const s=v>=0?'+':'';return`${s}${parseFloat(v||0).toFixed(2)}%`;}
function cls(v){return parseFloat(v||0)>=0?'green':'red';}

function buildSparkline(id,eq,color){
  if(sparkCharts[id])sparkCharts[id].destroy();
  const ctx=document.getElementById(id);
  if(!ctx||!eq||eq.length<2)return;
  const vals=eq.map(d=>parseFloat(d.equity));
  const g=ctx.getContext('2d').createLinearGradient(0,0,0,50);
  g.addColorStop(0,color+'44');g.addColorStop(1,color+'00');
  sparkCharts[id]=new Chart(ctx,{type:'line',data:{labels:vals.map((_,i)=>i),datasets:[{data:vals,borderColor:color,backgroundColor:g,borderWidth:1.5,pointRadius:0,fill:true,tension:0.4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{enabled:false}},scales:{x:{display:false},y:{display:false}}}});
}

function renderCard(key,stats,eq){
  const cfg=EA_CONFIG[key];const p=cfg.prefix;
  const d=stats&&stats.length>0?stats[0]:null;
  if(!d)return;
  const tEl=document.getElementById(`${p}-total-pnl`);
  tEl.textContent=fUSD(d.total_pnl||0);tEl.className=`ea-main-value ${cls(d.total_pnl||0)}`;
  const mEl=document.getElementById(`${p}-month-pnl`);
  mEl.textContent=fUSD(d.monthly_pnl||0);mEl.className=`ea-stat-value ${cls(d.monthly_pnl||0)}`;
  document.getElementById(`${p}-winrate`).textContent=(d.win_rate||0).toFixed(1)+'%';
  document.getElementById(`${p}-balance`).textContent=fBal(d.balance);
  const gEl=document.getElementById(`${p}-growth`);
  gEl.textContent=fPct(d.growth_percent||0);gEl.className=`ea-stat-value ${(d.growth_percent||0)>=0?'gold':'red'}`;
  buildSparkline(`spark-${key}`,eq,cfg.color);
}

function renderHero(){
  let tb=0,tp=0,tm=0,lt=null;
  Object.keys(allData).forEach(k=>{
    const d=allData[k]&&allData[k].length>0?allData[k][0]:null;if(!d)return;
    tb+=parseFloat(d.balance||0);tp+=parseFloat(d.total_pnl||0);tm+=parseFloat(d.monthly_pnl||0);
    if(!lt||new Date(d.recorded_at)>new Date(lt))lt=d.recorded_at;
  });
  document.getElementById('hero-total').textContent=fBal(tb);
  const tEl=document.getElementById('h-total-pnl');tEl.textContent=fUSD(tp);tEl.className='hero-stat-value '+(tp>=0?'green':'red');
  const mEl=document.getElementById('h-monthly-pnl');mEl.textContent=fUSD(tm);mEl.className='hero-stat-value '+(tm>=0?'green':'red');
  if(lt){const dt=new Date(lt);document.getElementById('h-update').textContent=dt.toLocaleDateString('th-TH')+' '+dt.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'});}
}

function openDetail(key){
  currentEA=key;currentRange='all';
  const cfg=EA_CONFIG[key];const d=allData[key]&&allData[key].length>0?allData[key][0]:null;const eq=allEquity[key]||[];
  document.getElementById('d-port-label').textContent='PORT #'+cfg.port;
  document.getElementById('d-name').textContent=cfg.name;
  document.getElementById('d-sub').textContent='PORT #'+cfg.port+' · XAUUSD';
  if(d){
    document.getElementById('d-balance').textContent=fBal(d.balance);
    document.getElementById('d-equity').textContent=fBal(d.equity);
    const fEl=document.getElementById('d-floating');fEl.textContent=fUSD(d.floating_pnl||0);fEl.style.color=(d.floating_pnl||0)>=0?'var(--green)':'var(--red)';
    const tEl=document.getElementById('d-total-pnl');tEl.textContent=fUSD(d.total_pnl||0);tEl.className='d-stat-value '+(d.total_pnl>=0?'green':'red');
    const mEl=document.getElementById('d-month-pnl');mEl.textContent=fUSD(d.monthly_pnl||0);mEl.className='d-stat-value '+(d.monthly_pnl>=0?'green':'red');
    const dEl=document.getElementById('d-daily-pnl');dEl.textContent=fUSD(d.daily_pnl||0);dEl.className='d-stat-value '+(d.daily_pnl>=0?'green':'red');
    document.getElementById('d-growth').textContent=fPct(d.growth_percent||0);
    document.getElementById('d-winrate').textContent=(d.win_rate||0).toFixed(1)+'%';
    document.getElementById('d-pf').textContent=(d.profit_factor||0).toFixed(2);
    document.getElementById('d-dd').textContent=(d.drawdown_percent||0).toFixed(2)+'%';
    document.getElementById('d-open').textContent=d.open_orders||0;
    const dp=document.getElementById('dp-daily');dp.textContent=fUSD(d.daily_pnl||0);dp.className='pnl-val '+(d.daily_pnl>=0?'green':'red');
    const mp=document.getElementById('dp-month');mp.textContent=fUSD(d.monthly_pnl||0);mp.className='pnl-val '+(d.monthly_pnl>=0?'green':'red');
    const tp=document.getElementById('dp-total');tp.textContent=fUSD(d.total_pnl||0);tp.className='pnl-val '+(d.total_pnl>=0?'green':'red');
    document.getElementById('dp-trades').textContent=d.total_trades||0;
    document.getElementById('dp-winlose').textContent=`${d.winning_trades||0} / ${d.losing_trades||0}`;
  }
  ['all','3m','1m','1w'].forEach(r=>{document.getElementById('r-'+r).style.color=r==='all'?'var(--accent)':'var(--muted)';});
  buildDetailChart(eq,cfg.color);
  document.getElementById('home-page').style.display='none';
  document.getElementById('detail-page').style.display='block';
  window.scrollTo(0,0);
}

function closeDetail(){
  document.getElementById('detail-page').style.display='none';
  document.getElementById('home-page').style.display='block';
  if(detailChart){detailChart.destroy();detailChart=null;}
}

function buildDetailChart(eq,color){
  if(detailChart){detailChart.destroy();detailChart=null;}
  const f=filterRange(eq,currentRange);
  if(!f||f.length<2)return;
  const labels=f.map(d=>{const dt=new Date(d.recorded_at);return dt.toLocaleDateString('th-TH',{day:'2-digit',month:'short'});});
  const eqV=f.map(d=>parseFloat(d.equity));const balV=f.map(d=>parseFloat(d.balance));
  const ctx=document.getElementById('detailChart').getContext('2d');
  const g=ctx.createLinearGradient(0,0,0,260);g.addColorStop(0,color+'40');g.addColorStop(1,color+'00');
  detailChart=new Chart(ctx,{type:'line',data:{labels,datasets:[
    {label:'Equity',data:eqV,borderColor:color,backgroundColor:g,borderWidth:2,pointRadius:f.length>30?0:3,fill:true,tension:0.4},
    {label:'Balance',data:balV,borderColor:'rgba(200,168,90,0.5)',backgroundColor:'transparent',borderWidth:1.5,borderDash:[4,4],pointRadius:0,fill:false,tension:0.4}
  ]},options:{responsive:true,maintainAspectRatio:false,interaction:{intersect:false,mode:'index'},plugins:{legend:{labels:{color:'#556070',font:{family:'DM Mono',size:10},boxWidth:20,padding:14}},tooltip:{backgroundColor:'#0f1318',borderColor:'#1c2330',borderWidth:1,titleColor:'#556070',bodyColor:'#dde3ed',titleFont:{family:'DM Mono',size:10},bodyFont:{family:'DM Mono',size:11},callbacks:{label:c=>`${c.dataset.label}: $${c.parsed.y.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}`}}},scales:{x:{grid:{color:'rgba(28,35,48,0.5)'},ticks:{color:'#556070',font:{family:'DM Mono',size:9},maxTicksLimit:8}},y:{grid:{color:'rgba(28,35,48,0.5)'},ticks:{color:'#556070',font:{family:'DM Mono',size:9},callback:v=>'$'+v.toLocaleString('en-US')}}}}});
}

function filterRange(data,range){
  if(range==='all'||!data)return data;
  const now=new Date(),cut=new Date();
  if(range==='1w')cut.setDate(now.getDate()-7);
  if(range==='1m')cut.setMonth(now.getMonth()-1);
  if(range==='3m')cut.setMonth(now.getMonth()-3);
  return data.filter(d=>new Date(d.recorded_at)>=cut);
}

function setRange(r){
  currentRange=r;
  ['all','3m','1m','1w'].forEach(x=>{document.getElementById('r-'+x).style.color=x===r?'var(--accent)':'var(--muted)';});
  if(currentEA)buildDetailChart(allEquity[currentEA],EA_CONFIG[currentEA].color);
}

async function init(){
  await Promise.all(Object.keys(EA_CONFIG).map(async key=>{
    const[stats,equity]=await Promise.all([
      fetchSupa(`${key}_daily_stats`,'order=recorded_at.desc&limit=1'),
      fetchSupa(`${key}_equity_curve`,'order=recorded_at.asc&limit=365')
    ]);
    allData[key]=stats;allEquity[key]=equity;
    renderCard(key,stats,equity);
  }));
  renderHero();
  setTimeout(()=>{const o=document.getElementById('loading');o.style.opacity='0';setTimeout(()=>o.style.display='none',500);},1600);
}

init();
</script>
</body>
</html>
