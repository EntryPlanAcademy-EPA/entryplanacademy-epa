<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EntryPlan Academy ‚Äî Live Performance</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap');

:root {
  --bg:       #080a0d;
  --bg2:      #0e1117;
  --bg3:      #141920;
  --border:   #1c2330;
  --accent:   #c8a85a;
  --accent2:  #e6c97a;
  --green:    #2dd4a0;
  --red:      #f25c6e;
  --text:     #dde3ed;
  --muted:    #556070;
  --card:     #0f1318;
}

* { margin:0; padding:0; box-sizing:border-box; }

html { scroll-behavior: smooth; }

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* Noise texture overlay */
body::after {
  content:'';
  position:fixed;
  inset:0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.035'/%3E%3C/svg%3E");
  pointer-events:none;
  z-index:9999;
  opacity:0.4;
}

/* ===== HEADER ===== */
header {
  border-bottom: 1px solid var(--border);
  padding: 0 48px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 72px;
  position: sticky;
  top: 0;
  background: rgba(8,10,13,0.92);
  backdrop-filter: blur(20px);
  z-index: 100;
}

.logo {
  display: flex;
  align-items: baseline;
  gap: 10px;
}

.logo-text {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 28px;
  letter-spacing: 2px;
  color: var(--text);
}

.logo-text span { color: var(--accent); }

.logo-sub {
  font-family: 'DM Mono', monospace;
  font-size: 10px;
  color: var(--muted);
  letter-spacing: 2px;
  text-transform: uppercase;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 24px;
}

.live-badge {
  display: flex;
  align-items: center;
  gap: 7px;
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  letter-spacing: 1.5px;
  color: var(--green);
  text-transform: uppercase;
}

.live-dot {
  width: 7px; height: 7px;
  background: var(--green);
  border-radius: 50%;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%,100% { opacity:1; transform:scale(1); }
  50% { opacity:0.4; transform:scale(1.3); }
}

.last-update {
  font-family: 'DM Mono', monospace;
  font-size: 10px;
  color: var(--muted);
  letter-spacing: 0.5px;
}

/* ===== HERO ===== */
.hero {
  padding: 56px 48px 40px;
  border-bottom: 1px solid var(--border);
  position: relative;
  overflow: hidden;
}

.hero::before {
  content: 'EPA';
  position: absolute;
  right: -20px;
  top: -30px;
  font-family: 'Bebas Neue', sans-serif;
  font-size: 280px;
  color: rgba(200,168,90,0.03);
  pointer-events: none;
  line-height: 1;
  letter-spacing: -5px;
}

.hero-label {
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  letter-spacing: 3px;
  color: var(--accent);
  text-transform: uppercase;
  margin-bottom: 14px;
}

.hero-balance {
  font-family: 'Bebas Neue', sans-serif;
  font-size: clamp(52px, 8vw, 96px);
  letter-spacing: 2px;
  line-height: 1;
  color: var(--text);
  margin-bottom: 8px;
}

.hero-equity {
  font-family: 'DM Mono', monospace;
  font-size: 14px;
  color: var(--muted);
  margin-bottom: 32px;
}

.hero-equity span { color: var(--text); }

.hero-stats {
  display: flex;
  gap: 0;
  flex-wrap: wrap;
}

.hero-stat {
  padding: 16px 32px 16px 0;
  border-right: 1px solid var(--border);
  margin-right: 32px;
}

.hero-stat:last-child { border-right: none; }

.hero-stat-label {
  font-family: 'DM Mono', monospace;
  font-size: 10px;
  letter-spacing: 2px;
  color: var(--muted);
  text-transform: uppercase;
  margin-bottom: 6px;
}

.hero-stat-value {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 28px;
  letter-spacing: 1px;
}

.hero-stat-value.green { color: var(--green); }
.hero-stat-value.red { color: var(--red); }
.hero-stat-value.gold { color: var(--accent2); }

/* ===== MAIN GRID ===== */
.main {
  padding: 40px 48px;
  display: grid;
  grid-template-columns: 1fr 340px;
  gap: 24px;
}

@media (max-width: 1024px) {
  .main { grid-template-columns: 1fr; }
  header { padding: 0 24px; }
  .hero { padding: 40px 24px 32px; }
  .main { padding: 24px; }
}

/* ===== CARDS ===== */
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 2px;
  overflow: hidden;
}

.card-header {
  padding: 18px 22px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.card-title {
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--muted);
}

.card-body { padding: 22px; }

/* ===== CHART ===== */
.chart-wrap {
  position: relative;
  height: 280px;
}

/* ===== STATS GRID ===== */
.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1px;
  background: var(--border);
  margin-bottom: 24px;
}

.stat-box {
  background: var(--card);
  padding: 20px 22px;
}

.stat-box-label {
  font-family: 'DM Mono', monospace;
  font-size: 10px;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 8px;
}

.stat-box-value {
  font-size: 20px;
  font-weight: 600;
  letter-spacing: -0.3px;
}

.stat-box-value.green { color: var(--green); }
.stat-box-value.red { color: var(--red); }
.stat-box-value.gold { color: var(--accent2); }

/* ===== SIDE PANEL ===== */
.side-panel { display: flex; flex-direction: column; gap: 24px; }

/* ===== PNL BARS ===== */
.pnl-section { margin-bottom: 6px; }

.pnl-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
}

.pnl-row:last-child { border-bottom: none; }

.pnl-period {
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  color: var(--muted);
  letter-spacing: 1px;
  text-transform: uppercase;
}

.pnl-value {
  font-size: 15px;
  font-weight: 600;
  font-family: 'DM Mono', monospace;
}

.pnl-value.green { color: var(--green); }
.pnl-value.red { color: var(--red); }

/* ===== METER ===== */
.meter-wrap { margin-bottom: 16px; }

.meter-label {
  display: flex;
  justify-content: space-between;
  margin-bottom: 6px;
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  color: var(--muted);
  letter-spacing: 1px;
}

.meter-label span { color: var(--text); font-weight: 500; }

.meter-bar {
  height: 5px;
  background: var(--bg3);
  border-radius: 2px;
  overflow: hidden;
}

.meter-fill {
  height: 100%;
  border-radius: 2px;
  transition: width 1s ease;
}

.meter-fill.green { background: var(--green); }
.meter-fill.gold { background: var(--accent); }
.meter-fill.red { background: var(--red); }

/* ===== OPEN ORDERS ===== */
.orders-count {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 16px 0;
}

.orders-number {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 56px;
  color: var(--accent2);
  line-height: 1;
}

.orders-label {
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  color: var(--muted);
  letter-spacing: 1.5px;
  text-transform: uppercase;
  line-height: 1.6;
}

/* ===== SKELETON ===== */
.skeleton {
  background: linear-gradient(90deg, var(--bg3) 25%, var(--border) 50%, var(--bg3) 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  border-radius: 2px;
}

@keyframes shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* ===== FOOTER ===== */
footer {
  border-top: 1px solid var(--border);
  padding: 20px 48px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.footer-text {
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  color: var(--muted);
  letter-spacing: 0.5px;
}

.footer-disclaimer {
  font-family: 'DM Mono', monospace;
  font-size: 10px;
  color: var(--muted);
  opacity: 0.5;
  max-width: 500px;
  text-align: right;
  line-height: 1.6;
}

/* ===== LOADING ===== */
#loading-overlay {
  position: fixed;
  inset: 0;
  background: var(--bg);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  transition: opacity 0.5s ease;
}

.loading-logo {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 48px;
  letter-spacing: 4px;
  color: var(--text);
  margin-bottom: 8px;
}

.loading-logo span { color: var(--accent); }

.loading-bar {
  width: 200px;
  height: 2px;
  background: var(--border);
  border-radius: 1px;
  overflow: hidden;
  margin-top: 24px;
}

.loading-fill {
  height: 100%;
  background: var(--accent);
  border-radius: 1px;
  animation: loadbar 1.5s ease forwards;
}

@keyframes loadbar {
  from { width: 0%; }
  to { width: 100%; }
}

.loading-text {
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  color: var(--muted);
  letter-spacing: 2px;
  margin-top: 12px;
  text-transform: uppercase;
}

/* Fade in animation */
.fade-in {
  opacity: 0;
  transform: translateY(12px);
  animation: fadeIn 0.5s ease forwards;
}

@keyframes fadeIn {
  to { opacity:1; transform:translateY(0); }
}

.fade-in:nth-child(1) { animation-delay: 0.1s; }
.fade-in:nth-child(2) { animation-delay: 0.2s; }
.fade-in:nth-child(3) { animation-delay: 0.3s; }
.fade-in:nth-child(4) { animation-delay: 0.4s; }

/* No data state */
.no-data {
  text-align: center;
  padding: 60px 20px;
  color: var(--muted);
}

.no-data-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.4; }
.no-data-text { font-family: 'DM Mono', monospace; font-size: 12px; letter-spacing: 1px; }
</style>
</head>
<body>

<!-- Loading -->
<div id="loading-overlay">
  <div class="loading-logo">Entry<span>Plan</span></div>
  <div style="font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);letter-spacing:3px;">ACADEMY</div>
  <div class="loading-bar"><div class="loading-fill"></div></div>
  <div class="loading-text">Loading performance data...</div>
</div>

<!-- Header -->
<header>
  <div class="logo">
    <div>
      <div class="logo-text">Entry<span>Plan</span></div>
      <div class="logo-sub">Academy</div>
    </div>
  </div>
  <div class="header-right">
    <div class="live-badge">
      <div class="live-dot"></div>
      Live Performance
    </div>
    <div class="last-update" id="last-update">‚Äî</div>
  </div>
</header>

<!-- Hero -->
<section class="hero">
  <div class="hero-label">Master Account ‚Äî USD</div>
  <div class="hero-balance" id="hero-balance">$0.00</div>
  <div class="hero-equity">Equity: <span id="hero-equity">$0.00</span> &nbsp;¬∑&nbsp; Floating: <span id="hero-floating">$0.00</span></div>
  <div class="hero-stats">
    <div class="hero-stat fade-in">
      <div class="hero-stat-label">Total P&L</div>
      <div class="hero-stat-value green" id="stat-total-pnl">+$0.00</div>
    </div>
    <div class="hero-stat fade-in">
      <div class="hero-stat-label">Growth</div>
      <div class="hero-stat-value gold" id="stat-growth">+0.00%</div>
    </div>
    <div class="hero-stat fade-in">
      <div class="hero-stat-label">Win Rate</div>
      <div class="hero-stat-value" id="stat-winrate">0%</div>
    </div>
    <div class="hero-stat fade-in">
      <div class="hero-stat-label">Profit Factor</div>
      <div class="hero-stat-value" id="stat-pf">0.00</div>
    </div>
    <div class="hero-stat fade-in">
      <div class="hero-stat-label">Max Drawdown</div>
      <div class="hero-stat-value red" id="stat-dd">0.00%</div>
    </div>
  </div>
</section>

<!-- Main -->
<div class="main">

  <!-- Left Column -->
  <div>
    <!-- Equity Curve -->
    <div class="card" style="margin-bottom:24px">
      <div class="card-header">
        <div class="card-title">Equity Curve</div>
        <div style="display:flex;gap:16px;font-family:'DM Mono',monospace;font-size:10px;color:var(--muted)">
          <span style="cursor:pointer" onclick="setChartRange('all')" id="range-all">ALL</span>
          <span style="cursor:pointer" onclick="setChartRange('3m')" id="range-3m">3M</span>
          <span style="cursor:pointer" onclick="setChartRange('1m')" id="range-1m">1M</span>
          <span style="cursor:pointer" onclick="setChartRange('1w')" id="range-1w">1W</span>
        </div>
      </div>
      <div class="card-body">
        <div class="chart-wrap">
          <canvas id="equityChart"></canvas>
          <div class="no-data" id="chart-nodata" style="display:none">
            <div class="no-data-icon">üìà</div>
            <div class="no-data-text">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å EA ‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏Å</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid fade-in">
      <div class="stat-box">
        <div class="stat-box-label">Total Trades</div>
        <div class="stat-box-value" id="s-total-trades">‚Äî</div>
      </div>
      <div class="stat-box">
        <div class="stat-box-label">Winning Trades</div>
        <div class="stat-box-value green" id="s-win-trades">‚Äî</div>
      </div>
      <div class="stat-box">
        <div class="stat-box-label">Losing Trades</div>
        <div class="stat-box-value red" id="s-lose-trades">‚Äî</div>
      </div>
      <div class="stat-box">
        <div class="stat-box-label">Open Orders</div>
        <div class="stat-box-value gold" id="s-open-orders">‚Äî</div>
      </div>
    </div>
  </div>

  <!-- Right Column -->
  <div class="side-panel">

    <!-- P&L Summary -->
    <div class="card fade-in">
      <div class="card-header">
        <div class="card-title">P&L Summary</div>
      </div>
      <div class="card-body">
        <div class="pnl-section">
          <div class="pnl-row">
            <div class="pnl-period">Today</div>
            <div class="pnl-value" id="pnl-today">‚Äî</div>
          </div>
          <div class="pnl-row">
            <div class="pnl-period">This Month</div>
            <div class="pnl-value" id="pnl-month">‚Äî</div>
          </div>
          <div class="pnl-row">
            <div class="pnl-period">All Time</div>
            <div class="pnl-value" id="pnl-total">‚Äî</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Performance Meters -->
    <div class="card fade-in">
      <div class="card-header">
        <div class="card-title">Performance</div>
      </div>
      <div class="card-body">
        <div class="meter-wrap">
          <div class="meter-label">Win Rate <span id="m-winrate">0%</span></div>
          <div class="meter-bar"><div class="meter-fill green" id="m-winrate-bar" style="width:0%"></div></div>
        </div>
        <div class="meter-wrap">
          <div class="meter-label">Growth <span id="m-growth">0%</span></div>
          <div class="meter-bar"><div class="meter-fill gold" id="m-growth-bar" style="width:0%"></div></div>
        </div>
        <div class="meter-wrap">
          <div class="meter-label">Max Drawdown <span id="m-dd">0%</span></div>
          <div class="meter-bar"><div class="meter-fill red" id="m-dd-bar" style="width:0%"></div></div>
        </div>
      </div>
    </div>

    <!-- Open Orders -->
    <div class="card fade-in">
      <div class="card-header">
        <div class="card-title">Open Orders</div>
      </div>
      <div class="card-body">
        <div class="orders-count">
          <div class="orders-number" id="open-orders-num">‚Äî</div>
          <div class="orders-label">Active<br>Positions</div>
        </div>
        <div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);line-height:1.8;letter-spacing:0.5px;">
          ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á TP/SL<br>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Footer -->
<footer>
  <div class="footer-text">¬© 2025 EntryPlan Academy</div>
  <div class="footer-disclaimer">Past performance is not indicative of future results. Trading involves risk.</div>
</footer>

<script>
// ===== CONFIG =====
const SUPABASE_URL = 'https://stdvqepkkkeehojstfww.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN0ZHZxZXBra2tlZWhvanN0Znd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyNTE5MjMsImV4cCI6MjA4NzgyNzkyM30.g25XS-O44n-Nf01-pRKy3pBH4OpYwQ7nbia67vHtx04';

// ===== STATE =====
let equityData = [];
let chart = null;
let currentRange = 'all';

// ===== FETCH =====
async function fetchSupabase(table, query = '') {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${query}`, {
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type': 'application/json'
    }
  });
  return res.json();
}

// ===== FORMAT =====
function fmtUSD(val) {
  if (val === null || val === undefined) return '‚Äî';
  const abs = Math.abs(val);
  const sign = val >= 0 ? '+' : '-';
  return `${sign}$${abs.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
}

function fmtBalance(val) {
  return '$' + parseFloat(val).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
}

function fmtPct(val) {
  const sign = val >= 0 ? '+' : '';
  return `${sign}${parseFloat(val).toFixed(2)}%`;
}

function colorClass(val) {
  return parseFloat(val) >= 0 ? 'green' : 'red';
}

// ===== RENDER STATS =====
function renderStats(data) {
  if (!data || data.length === 0) return;
  const d = data[0]; // latest

  // Hero
  document.getElementById('hero-balance').textContent = fmtBalance(d.balance);
  document.getElementById('hero-equity').textContent = fmtBalance(d.equity);
  const floating = d.floating_pnl || 0;
  const floatEl = document.getElementById('hero-floating');
  floatEl.textContent = fmtUSD(floating);
  floatEl.style.color = floating >= 0 ? 'var(--green)' : 'var(--red)';

  // Hero stats
  const tpnl = d.total_pnl || 0;
  const tpnlEl = document.getElementById('stat-total-pnl');
  tpnlEl.textContent = fmtUSD(tpnl);
  tpnlEl.className = 'hero-stat-value ' + colorClass(tpnl);

  const growth = d.growth_percent || 0;
  const growthEl = document.getElementById('stat-growth');
  growthEl.textContent = fmtPct(growth);
  growthEl.className = 'hero-stat-value ' + (growth >= 0 ? 'gold' : 'red');

  document.getElementById('stat-winrate').textContent = (d.win_rate || 0).toFixed(1) + '%';
  document.getElementById('stat-pf').textContent = (d.profit_factor || 0).toFixed(2);

  const dd = d.drawdown_percent || 0;
  document.getElementById('stat-dd').textContent = dd.toFixed(2) + '%';

  // Stats grid
  document.getElementById('s-total-trades').textContent = d.total_trades || 0;
  document.getElementById('s-win-trades').textContent = d.winning_trades || 0;
  document.getElementById('s-lose-trades').textContent = d.losing_trades || 0;
  document.getElementById('s-open-orders').textContent = d.open_orders || 0;
  document.getElementById('open-orders-num').textContent = d.open_orders || 0;

  // P&L rows
  const pnlToday = d.daily_pnl || 0;
  const pnlTodayEl = document.getElementById('pnl-today');
  pnlTodayEl.textContent = fmtUSD(pnlToday);
  pnlTodayEl.className = 'pnl-value ' + colorClass(pnlToday);

  const pnlMonth = d.monthly_pnl || 0;
  const pnlMonthEl = document.getElementById('pnl-month');
  pnlMonthEl.textContent = fmtUSD(pnlMonth);
  pnlMonthEl.className = 'pnl-value ' + colorClass(pnlMonth);

  const pnlTotalEl = document.getElementById('pnl-total');
  pnlTotalEl.textContent = fmtUSD(tpnl);
  pnlTotalEl.className = 'pnl-value ' + colorClass(tpnl);

  // Meters
  const wr = Math.min(d.win_rate || 0, 100);
  document.getElementById('m-winrate').textContent = wr.toFixed(1) + '%';
  document.getElementById('m-winrate-bar').style.width = wr + '%';

  const gr = Math.min(Math.max(growth, 0), 100);
  document.getElementById('m-growth').textContent = fmtPct(growth);
  document.getElementById('m-growth-bar').style.width = gr + '%';

  const ddPct = Math.min(dd, 100);
  document.getElementById('m-dd').textContent = dd.toFixed(2) + '%';
  document.getElementById('m-dd-bar').style.width = ddPct + '%';

  // Last update
  const updated = new Date(d.recorded_at);
  document.getElementById('last-update').textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ' + updated.toLocaleDateString('th-TH') + ' ' + updated.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
}

// ===== CHART =====
function buildChart(data) {
  if (!data || data.length === 0) {
    document.getElementById('chart-nodata').style.display = 'block';
    return;
  }

  const filtered = filterByRange(data, currentRange);
  const labels = filtered.map(d => {
    const dt = new Date(d.recorded_at);
    return dt.toLocaleDateString('th-TH', {day:'2-digit', month:'short'});
  });
  const equityVals = filtered.map(d => parseFloat(d.equity));
  const balanceVals = filtered.map(d => parseFloat(d.balance));

  const ctx = document.getElementById('equityChart').getContext('2d');

  const gradientEq = ctx.createLinearGradient(0, 0, 0, 280);
  gradientEq.addColorStop(0, 'rgba(45,212,160,0.25)');
  gradientEq.addColorStop(1, 'rgba(45,212,160,0)');

  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Equity',
          data: equityVals,
          borderColor: '#2dd4a0',
          backgroundColor: gradientEq,
          borderWidth: 2,
          pointRadius: filtered.length > 30 ? 0 : 3,
          pointBackgroundColor: '#2dd4a0',
          fill: true,
          tension: 0.4
        },
        {
          label: 'Balance',
          data: balanceVals,
          borderColor: 'rgba(200,168,90,0.6)',
          backgroundColor: 'transparent',
          borderWidth: 1.5,
          borderDash: [4,4],
          pointRadius: 0,
          fill: false,
          tension: 0.4
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { intersect: false, mode: 'index' },
      plugins: {
        legend: {
          labels: {
            color: '#556070',
            font: { family: 'DM Mono', size: 10 },
            boxWidth: 20, padding: 16
          }
        },
        tooltip: {
          backgroundColor: '#0f1318',
          borderColor: '#1c2330',
          borderWidth: 1,
          titleColor: '#556070',
          bodyColor: '#dde3ed',
          titleFont: { family: 'DM Mono', size: 10 },
          bodyFont: { family: 'DM Mono', size: 11 },
          callbacks: {
            label: ctx => `${ctx.dataset.label}: $${ctx.parsed.y.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}`
          }
        }
      },
      scales: {
        x: {
          grid: { color: 'rgba(28,35,48,0.5)', drawBorder: false },
          ticks: { color: '#556070', font: { family: 'DM Mono', size: 9 }, maxTicksLimit: 8 }
        },
        y: {
          grid: { color: 'rgba(28,35,48,0.5)', drawBorder: false },
          ticks: {
            color: '#556070',
            font: { family: 'DM Mono', size: 9 },
            callback: v => '$' + v.toLocaleString('en-US')
          }
        }
      }
    }
  });
}

function filterByRange(data, range) {
  if (range === 'all') return data;
  const now = new Date();
  const cutoff = new Date();
  if (range === '1w') cutoff.setDate(now.getDate() - 7);
  if (range === '1m') cutoff.setMonth(now.getMonth() - 1);
  if (range === '3m') cutoff.setMonth(now.getMonth() - 3);
  return data.filter(d => new Date(d.recorded_at) >= cutoff);
}

function setChartRange(range) {
  currentRange = range;
  ['all','3m','1m','1w'].forEach(r => {
    document.getElementById('range-' + r).style.color = r === range ? 'var(--accent)' : 'var(--muted)';
  });
  buildChart(equityData);
}

// ===== INIT =====
async function init() {
  try {
    // Fetch latest stats
    const stats = await fetchSupabase('daily_stats', 'order=recorded_at.desc&limit=1');
    renderStats(stats);

    // Fetch equity curve history
    equityData = await fetchSupabase('equity_curve', 'order=recorded_at.asc&limit=365');
    buildChart(equityData);

    // Set default range highlight
    document.getElementById('range-all').style.color = 'var(--accent)';

  } catch(e) {
    console.error('Error fetching data:', e);
  }

  // Hide loading
  setTimeout(() => {
    const overlay = document.getElementById('loading-overlay');
    overlay.style.opacity = '0';
    setTimeout(() => overlay.style.display = 'none', 500);
  }, 1600);
}

init();
</script>
</body>
</html>
